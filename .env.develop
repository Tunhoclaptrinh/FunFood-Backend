/**
 * Upload Test Script
 * Test upload functionality
 */

const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');

const BASE_URL = 'http://localhost:3000/api';

// Test credentials
const TEST_USER = {
  email: 'user@funfood.com',
  password: '123456'
};

let authToken = null;

/**
 * Login to get token
 */
async function login() {
  try {
    const response = await axios.post(`${BASE_URL}/auth/login`, TEST_USER);
    authToken = response.data.data.token;
    console.log('âœ… Login successful');
    console.log('Token:', authToken.substring(0, 20) + '...');
    return authToken;
  } catch (error) {
    console.error('âŒ Login failed:', error.response?.data || error.message);
    process.exit(1);
  }
}

/**
 * Create test image
 */
function createTestImage() {
  const testImagePath = path.join(__dirname, 'test-image.jpg');
  
  // Create a simple 100x100 red square image (if doesn't exist)
  if (!fs.existsSync(testImagePath)) {
    console.log('âš ï¸  Test image not found. Please place a test image at:', testImagePath);
    console.log('Using placeholder...');
    
    // Create a minimal valid JPEG
    const buffer = Buffer.from([
      0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46,
      0x49, 0x46, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01,
      0x00, 0x01, 0x00, 0x00, 0xFF, 0xD9
    ]);
    fs.writeFileSync(testImagePath, buffer);
  }
  
  return testImagePath;
}

/**
 * Test 1: Upload Avatar
 */
async function testUploadAvatar() {
  console.log('\nðŸ“¤ Test 1: Upload Avatar');
  console.log('â”€'.repeat(50));
  
  try {
    const testImagePath = createTestImage();
    const formData = new FormData();
    formData.append('image', fs.createReadStream(testImagePath));
    
    const response = await axios.post(`${BASE_URL}/upload/avatar`, formData, {
      headers: {
        ...formData.getHeaders(),
        'Authorization': `Bearer ${authToken}`
      }
    });
    
    console.log('âœ… Avatar upload successful');
    console.log('URL:', response.data.data.url);
    console.log('Filename:', response.data.data.filename);
    
    return response.data.data.url;
  } catch (error) {
    console.error('âŒ Avatar upload failed:', error.response?.data || error.message);
    return null;
  }
}

/**
 * Test 2: Upload Product Image
 */
async function testUploadProductImage() {
  console.log('\nðŸ“¤ Test 2: Upload Product Image');
  console.log('â”€'.repeat(50));
  
  try {
    const productId = 1; // Use existing product
    const testImagePath = createTestImage();
    const formData = new FormData();
    formData.append('image', fs.createReadStream(testImagePath));
    
    const response = await axios.post(
      `${BASE_URL}/upload/product/${productId}`,
      formData,
      {
        headers: {
          ...formData.getHeaders(),
          'Authorization': `Bearer ${authToken}`
        }
      }
    );
    
    console.log('âœ… Product image upload successful');
    console.log('URL:', response.data.data.url);
    console.log('Product:', response.data.data.product.name);
    
    return response.data.data.url;
  } catch (error) {
    console.error('âŒ Product image upload failed:', error.response?.data || error.message);
    return null;
  }
}

/**
 * Test 3: Get File Info
 */
async function testGetFileInfo(url) {
  console.log('\nðŸ“Š Test 3: Get File Info');
  console.log('â”€'.repeat(50));
  
  try {
    const response = await axios.get(`${BASE_URL}/upload/file/info`, {
      params: { url },
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });
    
    console.log('âœ… File info retrieved');
    console.log('Filename:', response.data.data.filename);
    console.log('Size:', response.data.data.size, 'bytes');
    console.log('Created:', response.data.data.created);
    
    return response.data;
  } catch (error) {
    console.error('âŒ Get file info failed:', error.response?.data || error.message);
    return null;
  }
}

/**
 * Test 4: Get Storage Stats (Admin only)
 */
async function testGetStorageStats() {
  console.log('\nðŸ“Š Test 4: Get Storage Stats (Admin Only)');
  console.log('â”€'.repeat(50));
  
  try {
    // Login as admin
    const adminResponse = await axios.post(`${BASE_URL}/auth/login`, {
      email: 'admin@funfood.com',
      password: '123456'
    });
    
    const adminToken = adminResponse.data.data.token;
    
    const response = await axios.get(`${BASE_URL}/upload/stats`, {
      headers: {
        'Authorization': `Bearer ${adminToken}`
      }
    });
    
    console.log('âœ… Storage stats retrieved');
    console.log('Total Files:', response.data.data.totalFiles);
    console.log('Total Size:', response.data.data.totalSizeFormatted);
    console.log('\nBy Folder:');
    
    Object.entries(response.data.data.byFolder).forEach(([folder, stats]) => {
      console.log(`  ${folder}:`, stats.files, 'files,', stats.sizeFormatted);
    });
    
    return response.data;
  } catch (error) {
    console.error('âŒ Get storage stats failed:', error.response?.data || error.message);
    return null;
  }
}

/**
 * Run all tests
 */
async function runTests() {
  console.log('\nðŸ§ª Starting Upload Tests');
  console.log('='.repeat(50));
  
  // Login
  await login();
  
  // Test uploads
  const avatarUrl = await testUploadAvatar();
  const productUrl = await testUploadProductImage();
  
  // Test file info
  if (avatarUrl) {
    await testGetFileInfo(avatarUrl);
  }
  
  // Test storage stats (admin)
  await testGetStorageStats();
  
  console.log('\nâœ… All tests completed!');
  console.log('='.repeat(50));
}

// Run tests
runTests().catch(error => {
  console.error('Test suite failed:', error);
  process.exit(1);
});